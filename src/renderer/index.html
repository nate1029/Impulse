<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impulse IDE</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Funnel+Display:ital,wght@0,300..800;1,300..800&family=Playfair+Display:ital,wght@0,500..900;1,500..900&family=Source+Serif+4:ital,wght@0,300..900;1,300..900&family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
</head>
<body>
    <div class="app-container">
        <!-- Top Row: Tool strip (extreme left) + Menu bar -->
        <header class="top-row">
            <div class="tool-strip">
                <button id="compileBtn" class="action-btn verify" title="Verify (Ctrl+R)">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                </button>
                <button id="uploadBtn" class="action-btn upload" title="Upload (Ctrl+U)">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M5 12l7-7 7 7M12 5v14"/>
                    </svg>
                </button>
                <button id="buildDebugBtn" class="action-btn build-debug" title="Build/Debug">
                    <img src="../../assets/debug-alt-svgrepo-com%20(1).svg" alt="" class="build-debug-icon" width="16" height="16" aria-hidden="true">
                </button>
                <div class="board-port-selector">
                    <button id="boardPortDropdown" class="board-port-btn" title="Select Board and Port">
                        <img src="../../assets/chip.svg" alt="" class="board-port-btn-icon" width="14" height="14" aria-hidden="true">
                        <span id="boardPortDisplay" class="board-port-display">Select Board and Port</span>
                        <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </button>
                    <div id="boardPortDropdownMenu" class="board-port-dropdown-menu">
                        <div id="boardPortSavedOptions" class="board-port-saved-options"></div>
                        <div class="board-port-divider"></div>
                        <button id="selectOtherBoardPort" class="board-port-other-btn">Select other board and port...</button>
                    </div>
                </div>
            </div>
            <div class="top-row-right">
                <button id="serialMonitorBtn" class="action-btn serial-monitor" title="Serial Monitor (Ctrl+Shift+M)">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <path d="M7 8h4M7 12h8M7 16h6"/>
                    </svg>
                </button>
                <button id="serialPlotterBtn" class="action-btn serial-plotter" title="Serial Plotter">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                    </svg>
                </button>
                <span class="toolbar-divider" aria-hidden="true"></span>
                <button id="aiAgentTab" class="ai-agent-tab" title="AI Assistant (Ctrl+Shift+A)">
                    <img src="../../assets/wave-square-solid.svg" alt="" class="ai-agent-tab-icon" width="16" height="16" aria-hidden="true">
                </button>
            </div>
        </header>

        <!-- Workspace: Activity Bar + Sidebar (Explorer a step down) + Main Area -->
        <div class="workspace-row">
        <!-- Activity Bar -->
        <div class="activity-bar">
            <div class="activity-bar-top">
                <button class="activity-icon active" data-panel="explorer" title="Explorer (Ctrl+Shift+E)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                    </svg>
                </button>
                <button class="activity-icon" data-panel="boards" title="Board Manager">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="4" y="4" width="16" height="16" rx="2"/>
                        <circle cx="9" cy="9" r="1.5" fill="currentColor"/>
                        <circle cx="15" cy="9" r="1.5" fill="currentColor"/>
                        <circle cx="9" cy="15" r="1.5" fill="currentColor"/>
                        <circle cx="15" cy="15" r="1.5" fill="currentColor"/>
                    </svg>
                </button>
                <button class="activity-icon" data-panel="libraries" title="Library Manager">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20.5 7.27778L12 12M12 12L3.5 7.27778M12 12V21.5"/>
                        <path d="M20.5 16.7222L12 12L3.5 16.7222"/>
                        <path d="M3.5 7.27778L12 2.5L20.5 7.27778V16.7222L12 21.5L3.5 16.7222V7.27778Z"/>
                    </svg>
                </button>
                <button class="activity-icon" data-panel="serial" title="Serial Monitor">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <path d="M7 8h4M7 12h8M7 16h6"/>
                    </svg>
                </button>
            </div>
            <div class="activity-bar-bottom">
                <button class="activity-icon activity-theme-toggle" id="themeToggleBtn" title="Toggle dark/light mode">
                    <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"/>
                        <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                    </svg>
                    <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <!-- Explorer Panel -->
            <div class="sidebar-panel active" id="explorerPanel">
                <div class="sidebar-header">
                    <span class="sidebar-title">SKETCHBOOK</span>
                    <button class="sidebar-collapse-btn" id="collapseSidebar" title="Collapse">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 18l-6-6 6-6"/>
                        </svg>
                    </button>
                </div>
                <div class="sidebar-content">
                    <div class="sidebar-section">
                        <button class="open-folder-btn" id="openFolder">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                                <path d="M12 11v6M9 14h6"/>
                            </svg>
                            Open Folder
                        </button>
                    </div>
                    <div class="sidebar-section">
                        <div class="folder-label" id="folderLabel">
                            <span class="folder-icon">üìÅ</span>
                            <span>No folder open</span>
                        </div>
                        <div id="fileTree" class="file-tree"></div>
                    </div>
                </div>
            </div>

            <!-- Boards Panel -->
            <div class="sidebar-panel" id="boardsPanel">
                <div class="sidebar-header">
                    <span class="sidebar-title">Board Manager</span>
                    <button class="sidebar-collapse-btn" title="Collapse">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 18l-6-6 6-6"/>
                        </svg>
                    </button>
                </div>
                <div class="sidebar-content">
                    <div class="sidebar-section">
                        <div class="section-header">Select Board</div>
                        <select id="boardSelectSidebar" class="sidebar-select">
                            <option value="">Select Board...</option>
                        </select>
                    </div>
                    <div class="sidebar-section">
                        <div class="section-header">Select Port</div>
                        <select id="portSelectSidebar" class="sidebar-select">
                            <option value="">Select Port...</option>
                        </select>
                        <button id="refreshPortsSidebar" class="btn-small" style="margin-top: 8px;">
                            <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 4v6h-6M1 20v-6h6"/>
                                <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                            </svg>
                            Refresh Ports
                        </button>
                    </div>
                    <div class="sidebar-section">
                        <div id="cliStatus" class="cli-status">Checking CLI...</div>
                    </div>
                </div>
            </div>

            <!-- Libraries Panel -->
            <div class="sidebar-panel" id="librariesPanel">
                <div class="sidebar-header">
                    <span class="sidebar-title">Library Manager</span>
                    <button class="sidebar-collapse-btn" title="Collapse">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 18l-6-6 6-6"/>
                        </svg>
                    </button>
                </div>
                <div class="sidebar-content">
                    <div class="sidebar-section">
                        <div class="lib-search-row">
                            <input type="text" id="libSearchInput" class="sidebar-input" placeholder="Search libraries...">
                            <button id="libSearchBtn" class="btn-small">Search</button>
                        </div>
                        <button id="libUpdateIndex" class="btn-small" style="width: 100%;">
                            <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 4v6h-6M1 20v-6h6"/>
                                <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                            </svg>
                            Update Library Index
                        </button>
                    </div>
                    <div class="sidebar-section">
                        <div id="libList" class="lib-list">
                            <div class="lib-msg">Search for libraries above</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Serial Panel -->
            <div class="sidebar-panel" id="serialPanel">
                <div class="sidebar-header">
                    <span class="sidebar-title">Serial Monitor</span>
                    <button class="sidebar-collapse-btn" title="Collapse">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 18l-6-6 6-6"/>
                        </svg>
                    </button>
                </div>
                <div class="sidebar-content">
                    <div class="sidebar-section serial-controls">
                        <div class="serial-status">
                            <span class="serial-status-dot" id="serialStatusDot"></span>
                            <span id="serialStatusText">Disconnected</span>
                        </div>
                        <div class="section-header">Baud Rate</div>
                        <select id="baudRate" class="sidebar-select">
                            <option value="9600">9600</option>
                            <option value="19200">19200</option>
                            <option value="38400">38400</option>
                            <option value="57600">57600</option>
                            <option value="115200" selected>115200</option>
                        </select>
                        <button id="toggleSerial" class="serial-btn">
                            Open Serial Monitor
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area (Explorer is a step down; toolbar is in top-row above) -->
        <div class="main-area" id="arduinoWorkspace">
            <!-- Board/Port Selection Modal -->
            <div id="boardPortModal" class="board-port-modal">
                <div class="board-port-modal-content">
                    <div class="board-port-modal-header">
                        <h2>Select Other Board and Port</h2>
                        <button class="board-port-modal-close" id="boardPortModalClose">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 6L6 18M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    <div class="board-port-modal-description">
                        Select both a Board and a Port if you want to upload a sketch. If you only select a Board you will be able to compile, but not to upload your sketch.
                    </div>
                    <div class="board-port-modal-body">
                        <div class="board-port-modal-section">
                            <div class="board-port-modal-section-header">BOARDS</div>
                            <div class="board-port-search">
                                <input type="text" id="boardSearchInput" placeholder="Search board" class="board-port-search-input">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" class="board-port-search-icon">
                                    <circle cx="11" cy="11" r="8"/>
                                    <path d="m21 21-4.35-4.35"/>
                                </svg>
                            </div>
                            <div id="boardList" class="board-port-list">
                                <!-- Board list will be populated here -->
                            </div>
                        </div>
                        <div class="board-port-modal-section">
                            <div class="board-port-modal-section-header">PORTS</div>
                            <div id="portList" class="board-port-list">
                                <!-- Port list will be populated here -->
                            </div>
                            <label class="board-port-checkbox">
                                <input type="checkbox" id="showAllPorts">
                                <span>Show all ports</span>
                            </label>
                        </div>
                    </div>
                    <div class="board-port-modal-footer">
                        <button id="boardPortModalCancel" class="board-port-modal-btn cancel">CANCEL</button>
                        <button id="boardPortModalOk" class="board-port-modal-btn ok">OK</button>
                    </div>
                </div>
            </div>

            <!-- Editor Container -->
            <div class="editor-container">
                <!-- Tab Bar (multiple file tabs) -->
                <div class="tab-bar">
                    <div id="fileTabs" class="file-tabs">
                        <!-- Tabs are added dynamically when files are opened -->
                    </div>
                </div>

                <!-- Code Editor -->
                <div class="code-editor-wrapper">
                    <!-- Empty state when no file is open (plain; no text or buttons) -->
                    <div id="welcomeState" class="welcome-state"></div>
                    <!-- Editor shown when file is open -->
                    <div id="editorWrapper" class="editor-inner-wrapper" style="display: none;">
                        <textarea id="codeEditor"></textarea>
                    </div>
                </div>

                <!-- Output Panel -->
                <div id="outputPanel" class="output-panel">
                    <div class="output-tabs">
                        <button class="output-tab active" data-tab="console">Console</button>
                        <button class="output-tab" data-tab="serial">Serial Monitor</button>
                        <button class="output-tab" data-tab="problems">Problems</button>
                    </div>
                    <div id="consoleOutput" class="output-content active"></div>
                    <div id="serialOutput" class="output-content"></div>
                    <div id="problemsOutput" class="output-content"></div>
                    <div class="serial-input-row" id="serialInputRow" style="display: none;">
                        <input type="text" id="serialInput" placeholder="Send to serial...">
                        <button id="sendSerial">Send</button>
                    </div>
                </div>
            </div>
        </div>
        </div>
        <!-- end workspace-row -->

        <!-- AI Agent Panel: 1/3 width, minimal -->
        <div id="aiPanel" class="ai-panel-overlay">
            <div class="ai-panel-inner">
                <div id="aiMessages" class="ai-msg-area"></div>
                <div class="ai-composer">
                    <textarea id="aiInput" placeholder="Plan, @ for context, / for commands" rows="2"></textarea>
                    <div class="ai-composer-row">
                        <span class="ai-mode-wrap">
                            <svg class="ai-mode-ico" viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12c0-2 2-4 4-4s4 2 4 4-2 4-4 4-4-2-4-4zm8 0c0-2 2-4 4-4s4 2 4 4-2 4-4 4-4-2-4-4"/></svg>
                            <select id="aiModeSelect" class="ai-mode-select" title="Mode"><option value="agent">Agent</option><option value="ask">Ask</option><option value="debug">Debug</option></select>
                        </span>
                        <select id="aiModelSelect" class="ai-model-select" title="Model"><option value="">Model‚Ä¶</option></select>
                        <div class="ai-composer-actions">
                            <button id="aiSettingsBtn" class="ai-ico" title="API key"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-1.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h1.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v1.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-1.09a1.65 1.65 0 00-1.51 1z"/></svg></button>
                            <button type="button" class="ai-ico" title="Image" disabled aria-hidden="true"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg></button>
                            <button type="button" class="ai-ico" title="Voice" disabled aria-hidden="true"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2M12 19v4M8 23h8"/></svg></button>
                            <button type="button" id="aiSend" class="ai-send" title="Send"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
                        </div>
                    </div>
                </div>
                <div id="aiStatus" class="ai-status" aria-live="polite"></div>
            </div>
        </div>

        <!-- API Key Modal -->
        <div id="apiKeyModal" class="api-key-modal" aria-hidden="true">
            <div class="api-key-modal-content">
                <h3 class="api-key-modal-title">API Key</h3>
                <p id="apiKeyModalDescription" class="api-key-modal-description">Enter your API key for this provider.</p>
                <input type="password" id="apiKeyInput" class="api-key-input" placeholder="Paste your API key here" autocomplete="off"/>
                <div class="api-key-modal-actions">
                    <button type="button" id="apiKeyCancel" class="api-key-modal-btn cancel">Cancel</button>
                    <button type="button" id="apiKeySave" class="api-key-modal-btn ok">Save</button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="app-footer">
            <div class="footer-left"></div>
            <div class="footer-right"></div>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>
    <script src="renderer.js"></script>
</body>
</html>
